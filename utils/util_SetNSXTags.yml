##
##       Project: SDDC.Lab
##       Authors: Luis Chanu & Rutger Blom
##      Filename: utils/util_SetNSXTags.yml
##       Purpose: This module takes the "GetVMs_List.yml" file generated by util_GetVMs.yml, and after the user has applied appropriate Tags and Scopes, and uses it as the source of truth as to which VMs to apply the appropriate Tags to.
##
##    DISCLAIMER: This playbook is not yet functional, and should be considered as "Work In Progress".  It uses a module which is part of VMware's NSX-T Ansible modules on github, which can be found here: https://github.com/vmware/ansible-for-nsxt
##
##   Description:
##     1) In order to execute this playbook, run it as a regular using using the following command:
##                                                      ansible-playbook -e "@/full/path/to/GetVMs_List.yml" utils/util_SetNSXTags.yml
##
---
- hosts: localhost
  name: util_SetNSXTags.yml
  vars:
    - DEBUG:
        DisplayVMs: false                                                                   # Display VM information on screen during execution
    - NSXT:
        LocalManager: Pod-100-NSXT-LM-1.SDDC.Lab
        User: admin
        Password: VMware1!VMware1!

  tasks:
    - name: util_SetNSXTags_Playbook
      ansible.builtin.debug:
        msg: "Starting playbook: {{ ansible_play_name }}"

    - name: Display error message if "VMList" is not defined
      ansible.builtin.pause:
        seconds: 5
        prompt: |
          *****************************************************************************************************
          ****************************************** ERROR MESSAGE ********************************************
          *****************************************************************************************************

            This playbook reads in a variable called "VMList" from the GetVMs_List.yml file, and that
            variable cannot be found.  We cannot continue without this information.  Please check the
            contents of the filename provided, and correctly accordingly.
            
            If you have not first execute "utils/util_GetVMs.yml", please do so to create the required
            datafile.  Once that file is generated, modify it accordingly with your Tags and Scopes, and
            then rerun this file.  The syntax to re-run this playbook is as follows:

                      ansible-playbook -e "@/full/path/to/GetVMs_List.yml" utils/util_SetNSXTags.yml

          *****************************************************************************************************
      when:
        - VMList is not defined

    - name: Exit Ansible playbook if "VMList" is not defined
      ansible.builtin.meta: end_play
      when: VMList is not defined

    - name: DEBUG - Display VMs and Templates
      ansible.builtin.pause:
        seconds: 1
        prompt: |
          ================================== Show VM & Template Information ==================================

          VMList
          ======
          {{ VMList | to_nice_yaml }}

          ====================================================================================================
      when:
        - DEBUG.DisplayVMs == true

    - name: Apply NSX-T tags to VMs
      vmware.ansible_for_nsxt.nsxt_vm_tags:
        hostname: "{{ NSXT.LocalManager }}"
        username: "{{ NSXT.User }}"
        password: "{{ NSXT.Password }}"
        validate_certs: "{{ Common.PKI.ValidateCerts }}"
        virtual_machine_display_name: "{{ item.name }}"
        add_tags: "{{ item.tags }}"
      loop: "{{ VMList }}"
      ignore_errors: yes
